<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<style type="text/css">
/*
 * ----------------------------------------------------------------------------
 * "THE BEER-WARE LICENSE" (Revision 42):
 * <meernik@live.com> wrote this file. As long as you retain this notice you
 * can do whatever you want with this stuff. If we meet some day, and you think
 * this stuff is worth it, you can buy me a beer in return 
 * - Landon
 * ----------------------------------------------------------------------------
 */
body {
    font-family: sans-serif;
    background-color: black;
    color: #0FF;
    margin: 0;
}
input,textarea,button {
    background-color: #011;
    border: 1px solid #FB0;
    color: #0FF;
}

.pre {
    white-space: pre;
}

.username {
    font-family: monospace;
    font-size: 18pt;
}

.miniprofile {
    border: 1pt solid #0FF;
    border-radius: 3pt;
    display: inline-block;
}

.miniprofile .avatar {
    vertical-align: middle;
    max-width: 18pt;
    max-height: 18pt;
    margin: 2pt;
    box-shadow: 0 0 2pt 0 #00F;
}

.miniprofile .username {
    vertical-align: middle;
}

#topbar {
    padding: 2pt;
    border-bottom: 1pt solid #0FF;
    width:100%;
}
</style>
<title>Sofas all the way down</title>
<script type="application/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.3/d3.min.js"></script>
<script>
urls = {
    "posts": "http://localhost:5984/posts/",
    "uuids": "http://localhost:5984/_uuids",
    "changes": "http://localhost:5984/posts/_changes",
    "thread": "http://localhost:5984/posts/_design/posts/_view/thread"
}

users = { // XXX Test users, this shoud probably get deleted sometime.
    "djtëstio": { // In real life this will be a UUID
        "nick": "DJ Tëstio",
        "avatar": "/pages/davenport/prophat.jpg",
        "joindate": "2015-02-08T16:20+0000"
    }
}

var user = "djtëstio";

document.addEventListener("DOMContentLoaded", function() {
    var bump = function(postid, now) {
        d3.json(urls.posts + "postid", function(post) {
            post.last_replied = now;
        });
    }
    d3.select("#reply").on("click", function() {
        d3.xhr(urls.uuids, function(resp) {
            var now = new Date(resp.getResponseHeader('Date')).toISOString(),
                id = JSON.parse(resp.response)['uuids'][0],
                post = {
                    // These never change after its posted
                    "creator": user,
                    "owner": user,
                    "created": now,
                    "threadid": d3.select("#threadid").node().value,
                    "subject": d3.select("#subject").node().value,
                    // These change every edit
                    "lasted": now,
                    "content": d3.select("#post").node().value,
                    "renderer": "pre"
                };
            d3.xhr(urls.posts + id)
                .mimeType("application/json")
                .on('error', function(e) {
                    console.error(e); 
                    alert("SHIT POST");
                 })
                .on('load', function(resp) { 
                    var pdata = JSON.parse(resp.response);
                    console.log("GOOD JOB", pdata);
                    d3.select("#response").text(resp.response);
                 })
                .send('PUT', JSON.stringify(post));
                console.log("Attempted to post", post);
        });
    });

    d3.select("#reload").on("click", function() {
        d3.xhr(urls.thread)
            .on("error", function(resp) { console.error(JSON.parse(resp.response)); })
            .on('load', function(resp) {
                var posts = JSON.parse(resp.response)
                console.log("GOT SOME POSTS", posts);
            }) 
            .send('POST', JSON.stringify({
                "key": [d3.select("#threadid").node().value]
            }));
    });
});
</script>
</head>
<body>
<div id="topbar">
    <div id="you" class="miniprofile">
        <img class="avatar" src="prophat.jpg" />
        <span class="username">DJ Tëstio!</span>
    </div>
    <div id="important"></div>
    <div id="new"></div>
</div>
Threadid:<input type="text"id="threadid" /><br />
Subject:<input type="text" id="subject" /><br />
Post:<textarea id="post"></textarea><br />
Parentid:<input type="text" id="parentid" /><br />
<button class="davenport" id="reply">Reply</button>
<button class="davenport" id="interject">Interject</button>
<button class="davenport" id="reload">Reload</button>
<div class="davenport" id="posts">
</div>
<div class="davenport pre" id="response">
</div>

</body>
</html>
